name: Multi-Platform Build & Release

on:
  # åˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘æ­£å¼å‘å¸ƒ
  push:
    tags:
      - 'v*'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      build_ios:
        description: 'Build iOS'
        required: true
        default: true
        type: boolean
      build_android:
        description: 'Build Android'
        required: true
        default: true
        type: boolean

jobs:
  # iOS æ„å»ºä»»åŠ¡
  build-ios:
    if: ${{ inputs.build_ios != false || github.event_name != 'workflow_dispatch' }}
    runs-on: macos-latest
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ£ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        
    - name: ğŸ“¦ Dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Tests
      run: flutter test
      
    - name: ğŸ”¨ Build iOS
      run: |
        flutter clean
        flutter build ios --release --no-codesign
        
    - name: ğŸ“± Create IPA
      run: |
        cd build/ios/iphoneos
        mkdir -p Payload
        cp -R Runner.app Payload/
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        COMMIT_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
        zip -r "FlutterApp_iOS_${TIMESTAMP}_${COMMIT_SHORT}.ipa" Payload/
        echo "IPA_NAME=FlutterApp_iOS_${TIMESTAMP}_${COMMIT_SHORT}.ipa" >> $GITHUB_ENV
        
    - name: ğŸ“¤ Upload iOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: iOS-Build
        path: build/ios/iphoneos/${{ env.IPA_NAME }}
        retention-days: 30

  # Android æ„å»ºä»»åŠ¡
  build-android:
    if: ${{ inputs.build_android != false || github.event_name != 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ£ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        
    - name: ğŸ“¦ Dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Tests
      run: flutter test
      
    - name: ğŸ”¨ Build Android
      run: |
        flutter clean
        flutter build apk --release
        
    - name: ğŸ“± Rename APK
      run: |
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        COMMIT_SHORT=$(echo $GITHUB_SHA | cut -c1-7)
        cd build/app/outputs/flutter-apk/
        mv app-release.apk "FlutterApp_Android_${TIMESTAMP}_${COMMIT_SHORT}.apk"
        echo "APK_NAME=FlutterApp_Android_${TIMESTAMP}_${COMMIT_SHORT}.apk" >> $GITHUB_ENV
        
    - name: ğŸ“¤ Upload Android Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Android-Build
        path: build/app/outputs/flutter-apk/${{ env.APK_NAME }}
        retention-days: 30

  # å‘å¸ƒä»»åŠ¡ - ä¾èµ–äºæ„å»ºä»»åŠ¡å®Œæˆ
  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Download iOS Artifact
      if: ${{ always() && (inputs.build_ios != false || github.event_name != 'workflow_dispatch') }}
      uses: actions/download-artifact@v4
      with:
        name: iOS-Build
        path: ./release-files/
        
    - name: ğŸ“¥ Download Android Artifact
      if: ${{ always() && (inputs.build_android != false || github.event_name != 'workflow_dispatch') }}
      uses: actions/download-artifact@v4
      with:
        name: Android-Build
        path: ./release-files/
        
    - name: ğŸ‰ Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./release-files/*
        name: ğŸš€ Release ${{ github.ref_name }}
        body: |
          ## ğŸ‰ Flutter App Release ${{ github.ref_name }}
          
          ### ğŸ“± iOS å®‰è£…æ–¹æ³•:
          1. ä¸‹è½½ `.ipa` æ–‡ä»¶åˆ°ç”µè„‘
          2. ä½¿ç”¨ **Sideloadly** è¿æ¥ iPhone å®‰è£…
          3. åœ¨ iPhone è®¾ç½® â†’ é€šç”¨ â†’ VPNä¸è®¾å¤‡ç®¡ç† â†’ ä¿¡ä»»å¼€å‘è€…
          
          ### ğŸ¤– Android å®‰è£…æ–¹æ³•:
          1. ä¸‹è½½ `.apk` æ–‡ä»¶åˆ°æ‰‹æœº
          2. å…è®¸"æœªçŸ¥æ¥æº"åº”ç”¨å®‰è£…
          3. ç›´æ¥å®‰è£… APK æ–‡ä»¶
          
          ### ğŸ”§ ç‰ˆæœ¬ä¿¡æ¯:
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Flutter ç‰ˆæœ¬: 3.32.5
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹:
          - **iOS**: å…è´¹å¼€å‘è€…è´¦å·å®‰è£…çš„åº”ç”¨æœ‰æ•ˆæœŸ7å¤©
          - **Android**: éœ€è¦å¼€å¯"å…è®¸å®‰è£…æœªçŸ¥åº”ç”¨"é€‰é¡¹
          
          ---
          
          ğŸ¯ **å¿«é€Ÿå¼€å§‹**: é€‰æ‹©å¯¹åº”å¹³å°çš„æ–‡ä»¶ä¸‹è½½å®‰è£…å³å¯ï¼
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 